---
import Head from "@components/_head.astro"
import Topbar from "@components/dashboard/_topbar.astro"
import Sidenav from "@components/dashboard/_sidenav.astro"
import Footer from "@components/dashboard/_footer.astro"
import Scripts from "@components/_scripts.astro"

const title = "ALPHA | Branches"
const path = "../../dist"
const mainPage = "dashboard"
const page = "branches"
---

<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <Head title={title} path={path} />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-dark text-light">
    <div class="app-wrapper">
      <Topbar path={path} />
      <Sidenav path={path} mainPage={mainPage} page={page} />

      <main class="app-main">
        <div class="app-content">
          <div class="container-fluid">
            <div class="card bg-dark border-secondary">
              <div class="card-header d-flex justify-content-between align-items-center border-secondary">
                <h3 class="card-title text-light">Branch Management</h3>
                <span class="badge bg-info">MAIN BRANCH</span>
              </div>

              <div class="card-body">
                <ul class="nav nav-tabs" id="branchTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add-branch" type="button" role="tab">Add Branch</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-branches" type="button" role="tab">List Branches</button>
                  </li>
                </ul>

                <div class="tab-content mt-3">
                  <!-- Add Branch Tab -->
                  <div class="tab-pane fade show active" id="add-branch" role="tabpanel">
                    <form id="addBranchForm">
                      <div class="mb-3">
                        <label for="branchName" class="form-label text-light">Branch Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="branchName" placeholder="Enter branch name" />
                      </div>
                      <div class="mb-3">
                        <label for="branchCode" class="form-label text-light">Branch Code</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="branchCode" placeholder="Enter branch code" />
                      </div>
                      <div class="mb-3">
                        <label for="location" class="form-label text-light">Location</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="location" placeholder="Enter branch location" />
                      </div>
                      <div class="mb-3">
                        <label for="branchType" class="form-label text-light">Branch Type</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="branchType" value="Main Branch" />
                      </div>
                      <button type="submit" class="btn btn-primary">Add Branch</button>
                    </form>
                  </div>

                  <!-- List Branches Tab -->
                  <div class="tab-pane fade" id="list-branches" role="tabpanel">
                    <table id="branchTable" class="table table-dark table-striped table-bordered border-secondary">
                      <thead>
                        <tr>
                          <th>Branch Name</th>
                          <th>Location</th>
                          <th>Manager</th>
                          <th>Contact</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="branchTableBody">
                        <tr>
                          <td colspan="5" class="text-center">Loading...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <Footer />
    </div>

    <Scripts path={path} />
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script is:inline>
      document.addEventListener("DOMContentLoaded", function () {
        const table = new DataTable("#branchTable");
        const API_BASE = "http://arsocadmin-001-site1.ltempurl.com/api/";

        // Load branches
        async function loadBranches() {
          const token = localStorage.getItem("authToken"); // set via browser console
          const tbody = document.getElementById("branchTableBody");
          try {
            const response = await fetch(API_BASE + "list/branch", {
              headers: { "Authorization": `Bearer ${token}` }
            });
            const result = await response.json();
            const branches = result?.Branch_Response?.data;

            tbody.innerHTML = "";

            if (!branches || branches.length === 0) {
              tbody.innerHTML = `<tr><td colspan="5" class="text-center">No branches found</td></tr>`;
            } else {
              branches.forEach(b => {
                tbody.innerHTML += `
                  <tr>
                    <td>${b.branchName || ""}</td>
                    <td>${b.location || ""}</td>
                    <td>${b.manager || ""}</td>
                    <td>${b.contact || ""}</td>
                    <td>${b.status || ""}</td>
                  </tr>
                `;
              });
            }
          } catch (err) {
            console.error("Failed to load branches:", err);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading branches</td></tr>`;
          }
        }

        loadBranches();

        // Handle Add Branch form
        const form = document.getElementById("addBranchForm");
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          const token = localStorage.getItem("authToken");

          const payload = {
            branchName: document.getElementById("branchName").value,
            branchCode: document.getElementById("branchCode").value,
            location: document.getElementById("location").value,
            branchType: document.getElementById("branchType").value
          };

          try {
            const response = await fetch(API_BASE + "add/branch", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              alert("Branch added successfully!");
              form.reset();
              loadBranches(); // refresh table
            } else {
              alert("Error adding branch");
            }
          } catch (err) {
            console.error(err);
            alert("Network error");
          }
        });
      });
    </script>
  </body>
</html>
